# The vast majority of user submissions are just new keymaps/keyboards.
# Take additional care to validate these.
name: 'Validate Keymap Submission'

on:
  push:
    paths:
      - 'keyboards/**'
  pull_request:
    paths:
      - 'keyboards/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-keyboard:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Take ownership of the Vial repo dir
      run: chown -R $(id -u):$(id -g) $PWD

    - name: Fix submodules
      run: make git-submodule

    - name: Verify Vial UID is unique
      run: python3 util/ci_vial_verify_uid.py

    - name: Determine affected keyboards/keymaps
      id: file_changes
      uses: tj-actions/changed-files@v35
      with:
        files: keyboards/**
        separator: "|"

    - name: Check added files
      shell: 'bash {0}'
      run: |
        IFS=$'|' read -a NEW_FILES <<< "${{ steps.file_changes.outputs.added_files }}"
           for file in "${NEW_FILES[@]}"; do
             echo $file
           done
           unset IFS
